<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深蹲評估專業分析工具</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: white; overflow: hidden; font-family: sans-serif; }
        .app-container { display: flex; width: 100vw; height: 100vh; }

        /* 左側：影像與分析報告區 */
        .main-view { flex: 1; position: relative; background: #111; display: flex; justify-content: center; align-items: center; min-width: 0; }
        #output_canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* 右側：控制儀表板 */
        #dashboard { width: 320px; flex-shrink: 0; background: #222; border-left: 1px solid #444; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* 把握度門檻與錄製中燈號 */
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; height: 30px; }
        .threshold-group { display: flex; align-items: center; gap: 5px; font-size: 1rem; font-weight: bold; color: #fff; }
        #threshold_input { width: 3.5rem; background: #333; border: 1px solid #555; color: #00ffcc; padding: 3px; border-radius: 4px; text-align: center; font-size: 1rem; font-weight: bold; }
        #rec_indicator { font-size: 1rem; font-weight: bold; color: #ff4444; display: flex; align-items: center; }
        .dot { height: 10px; width: 10px; background: #ff4444; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* 左右對稱深淺色卡設計 */
        .data-grid { flex: 1; overflow-y: auto; padding-right: 5px; }
        .section-label { color: #888; font-size: 0.75rem; margin: 15px 0 5px; text-transform: uppercase; letter-spacing: 1px; }
        .row { padding: 10px 12px; margin: 5px 0; border-radius: 6px; font-family: monospace; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
        .row span:last-child { color: #fff; font-weight: bold; font-size: 1.1rem; }

        .shoulder-l { background: rgba(0, 121, 107, 0.3); border-left-color: #00796B; }
        .shoulder-r { background: rgba(77, 182, 172, 0.2); border-left-color: #4DB6AC; }
        .elbow-l { background: rgba(81, 45, 168, 0.3); border-left-color: #512DA8; }
        .elbow-r { background: rgba(149, 117, 205, 0.2); border-left-color: #9575CD; }
        .hip-l-row { background: rgba(13, 71, 161, 0.3); border-left-color: #0d47a1; }
        .hip-r-row { background: rgba(66, 165, 245, 0.2); border-left-color: #42a5f5; }
        .knee-l-row { background: rgba(27, 94, 32, 0.3); border-left-color: #1b5e20; }
        .knee-r-row { background: rgba(129, 199, 132, 0.2); border-left-color: #81c784; }
        .ankle-l { background: rgba(198, 40, 40, 0.3); border-left-color: #C62828; }
        .ankle-r { background: rgba(229, 115, 115, 0.2); border-left-color: #E57373; }

        .assessment-active .upper-body, .assessment-active .lower-body-only { display: none; }

        /* 按鈕樣式 */
        button { width: 100%; padding: 12px; margin: 4px 0; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        button:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-toggle { background: #555; }
        .btn-primary { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-secondary { background: #6c757d; }
        .btn-info { background: #17a2b8; }

        /* 報告頁面樣式 */
        #report_view { position: absolute; inset: 0; background: #1a1a1a; z-index: 100; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        .report-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .report-actions { display: flex; gap: 10px; }
        .report-actions button { width: auto; min-width: 100px; margin: 0; }
        .report-content { display: flex; gap: 20px; flex-shrink: 0; min-height: 850px; }
        .report-side { flex: 0 0 300px; display: flex; flex-direction: column; gap: 15px; }
        .report-main { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .report-card { background: #262626; border-radius: 10px; padding: 15px; border: 1px solid #444; }
        .card-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 8px; }
        #playback_video { width: 100%; max-height: 180px; border-radius: 5px; background: #000; object-fit: contain; }

        /* 圖表與指標 */
        .chart-title-center { text-align: center; width: 100%; font-size: 1rem; color: #fff; margin-bottom: 10px; font-weight: bold; }
        .chart-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 320px; }
        .chart-box { flex: 1; position: relative; width: 100%; height: 100%; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .stat-item { padding: 12px; border-radius: 8px; text-align: center; border-width: 2px; border-style: solid; }
        .stat-name { display: block; font-size: 0.7rem; opacity: 0.8; margin-bottom: 5px; }
        .stat-item span:last-child { font-size: 1.4rem; font-weight: bold; font-family: monospace; }
        
        .hip-l { background: rgba(13, 71, 161, 0.2); border-color: #0d47a1; color: #42a5f5; }
        .hip-r { background: rgba(66, 165, 245, 0.1); border-color: #42a5f5; color: #90caf9; }
        .knee-l { background: rgba(27, 94, 32, 0.2); border-color: #1b5e20; color: #66bb6a; }
        .knee-r { background: rgba(129, 199, 132, 0.1); border-color: #81c784; color: #a5d6a7; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="main-view">
        <video id="input_video" style="display:none;"></video>
        <canvas id="output_canvas"></canvas>
        
        <div id="report_view" style="display:none;">
            <div class="report-header">
                <h2>深蹲動作分析報告</h2>
                <div class="report-actions">
                    <button id="download_csv_report" class="btn-info">輸出報告</button>
                    <button id="back_to_live" class="btn-toggle">返回測試</button>
                </div>
            </div>
            <div class="report-content">
                <div class="report-side">
                    <div class="report-card">
                        <div class="card-label">動作重播</div>
                        <video id="playback_video" autoplay loop muted controls></video>
                    </div>
                    <div class="report-card">
                        <div class="card-label">最大角度</div>
                        <div class="stats-grid">
                            <div class="stat-item hip-l"><span class="stat-name">左髖</span><span id="max_l_hip">--</span></div>
                            <div class="stat-item hip-r"><span class="stat-name">右髖</span><span id="max_r_hip">--</span></div>
                            <div class="stat-item knee-l"><span class="stat-name">左膝</span><span id="max_l_knee">--</span></div>
                            <div class="stat-item knee-r"><span class="stat-name">右膝</span><span id="max_r_knee">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="report-main">
                    <div class="report-card chart-wrapper">
                        <div class="chart-title-center">髖關節角度</div>
                        <div class="chart-box"><canvas id="hip_chart"></canvas></div>
                    </div>
                    <div class="report-card chart-wrapper">
                        <div class="chart-title-center">膝關節角度</div>
                        <div class="chart-box"><canvas id="knee_chart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard">
        <div class="control-row">
            <div class="threshold-group">
                把握度門檻: <input type="number" id="threshold_input" value="0" min="0" max="100"> %
            </div>
            <div id="rec_indicator" style="display:none;"><span class="dot"></span>錄製中</div>
        </div>
        <div class="assessment-section">
            <button id="toggle_assessment" class="btn-toggle">進入深蹲評估模式</button>
            <div id="record_controls" style="display:none;">
                <button id="start_btn" class="btn-primary">開始評估</button>
                <button id="stop_btn" class="btn-danger" disabled>結束評估</button>
                <button id="report_btn" class="btn-secondary" disabled>查看報告</button>
            </div>
        </div>
        <hr>
        <div class="data-grid" id="angle_display_grid">
            <div class="section-label upper-body">上半身即時角度</div>
            <div class="row shoulder-l upper-body"><span>左肩</span><span id="l_shoulder">--</span></div>
            <div class="row shoulder-r upper-body"><span>右肩</span><span id="r_shoulder">--</span></div>
            <div class="row elbow-l upper-body"><span>左肘</span><span id="l_elbow">--</span></div>
            <div class="row elbow-r upper-body"><span>右肘</span><span id="r_elbow">--</span></div>
            <div class="section-label">下半身即時角度</div>
            <div class="row hip-l-row"><span>左髖</span><span id="l_hip">--</span></div>
            <div class="row hip-r-row"><span>右髖</span><span id="r_hip">--</span></div>
            <div class="row knee-l-row"><span>左膝</span><span id="l_knee">--</span></div>
            <div class="row knee-r-row"><span>右膝</span><span id="r_knee">--</span></div>
            <div class="row ankle-l lower-body-only"><span>左踝</span><span id="l_ankle">--</span></div>
            <div class="row ankle-r lower-body-only"><span>右踝</span><span id="r_ankle">--</span></div>
        </div>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const thresholdInput = document.getElementById('threshold_input');

    let isRecording = false;
    let recordingData = [];
    let mediaRecorder;
    let recordedChunks = [];
    let hipChart = null, kneeChart = null;

    function calculateAngle(p1, p2, p3) {
        if (!p1 || !p2 || !p3) return null;
        const v1 = { x: p1.x - p2.x, y: p1.y - p2.y, z: p1.z - p2.z };
        const v2 = { x: p3.x - p2.x, y: p3.y - p2.y, z: p3.z - p2.z };
        const dot = v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
        const mag1 = Math.sqrt(v1.x**2 + v1.y**2 + v1.z**2);
        const mag2 = Math.sqrt(v2.x**2 + v2.y**2 + v2.z**2);
        return Math.acos(Math.max(-1, Math.min(1, dot / (mag1 * mag2)))) * (180 / Math.PI);
    }

    function onResults(results) {
        if (!results.poseLandmarks) return;
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.translate(canvasElement.width, 0);
        canvasCtx.scale(-1, 1);
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#ffffff', lineWidth: 2});
        drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', radius: 2});

        const lm = results.poseLandmarks;
        const thr = parseFloat(thresholdInput.value) / 100;
        const idx = { lSh: 11, rSh: 12, lEl: 13, rEl: 14, lWr: 15, rWr: 16, lHi: 23, rHi: 24, lKn: 25, rKn: 26, lAn: 27, rAn: 28, lFt: 31, rFt: 32 };

        if (lm[idx.lHi] && lm[idx.rHi]) {
            const midX = ((lm[idx.lHi].x + lm[idx.rHi].x) / 2) * canvasElement.width;
            canvasCtx.beginPath(); canvasCtx.setLineDash([10, 5]); canvasCtx.moveTo(midX, 0); canvasCtx.lineTo(midX, canvasElement.height);
            canvasCtx.strokeStyle = 'yellow'; canvasCtx.lineWidth = 2; canvasCtx.stroke(); canvasCtx.setLineDash([]);
        }

        const angles = {
            l_shoulder: calculateAngle(lm[idx.lEl], lm[idx.lSh], lm[idx.lHi]),
            r_shoulder: calculateAngle(lm[idx.rEl], lm[idx.rSh], lm[idx.rHi]),
            l_elbow: 180 - calculateAngle(lm[idx.lSh], lm[idx.lEl], lm[idx.lWr]),
            r_elbow: 180 - calculateAngle(lm[idx.rSh], lm[idx.rEl], lm[idx.rWr]),
            l_hip: 180 - calculateAngle(lm[idx.lSh], lm[idx.lHi], lm[idx.lKn]),
            r_hip: 180 - calculateAngle(lm[idx.rSh], lm[idx.rHi], lm[idx.rKn]),
            l_knee: 180 - calculateAngle(lm[idx.lHi], lm[idx.lKn], lm[idx.lAn]),
            r_knee: 180 - calculateAngle(lm[idx.rHi], lm[idx.rKn], lm[idx.rAn]),
            l_ankle: 180 - calculateAngle(lm[idx.lKn], lm[idx.lAn], lm[idx.lFt]),
            r_ankle: 180 - calculateAngle(lm[idx.rKn], lm[idx.rAn], lm[idx.rFt])
        };

        Object.keys(angles).forEach(key => {
            const el = document.getElementById(key);
            if (el) el.innerText = lm[idx.lHi].visibility >= thr ? Math.round(angles[key]) + "°" : "N/A";
        });

        if (isRecording) recordingData.push({ t: recordingData.length, ...angles });
        canvasCtx.restore();
    }

    const startBtn = document.getElementById('start_btn');
    const stopBtn = document.getElementById('stop_btn');
    const reportBtn = document.getElementById('report_btn');
    const toggleBtn = document.getElementById('toggle_assessment');
    const recIndicator = document.getElementById('rec_indicator');

    startBtn.onclick = () => {
        recordedChunks = []; recordingData = []; isRecording = true;
        const stream = canvasElement.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            document.getElementById('playback_video').src = URL.createObjectURL(blob);
        };
        mediaRecorder.start();
        startBtn.disabled = true; stopBtn.disabled = false; reportBtn.disabled = true;
        recIndicator.style.display = 'flex';
    };

    stopBtn.onclick = () => {
        isRecording = false; mediaRecorder.stop();
        startBtn.disabled = false; stopBtn.disabled = true; reportBtn.disabled = false;
        recIndicator.style.display = 'none';
    };

    toggleBtn.onclick = function() {
        const ctrl = document.getElementById('record_controls');
        const grid = document.getElementById('angle_display_grid');
        const isHidden = ctrl.style.display === 'none';
        ctrl.style.display = isHidden ? 'block' : 'none';
        this.innerText = isHidden ? "退出深蹲評估模式" : "進入深蹲評估模式";
        grid.classList.toggle('assessment-active', isHidden);
    };

    reportBtn.onclick = () => {
        document.getElementById('report_view').style.display = 'flex';
        canvasElement.style.display = 'none';
        [toggleBtn, startBtn, stopBtn, reportBtn].forEach(btn => btn.disabled = true);

        const getMax = (k) => Math.max(...recordingData.map(d => d[k] || 0));
        document.getElementById('max_l_hip').innerText = Math.round(getMax('l_hip')) + "°";
        document.getElementById('max_r_hip').innerText = Math.round(getMax('r_hip')) + "°";
        document.getElementById('max_l_knee').innerText = Math.round(getMax('l_knee')) + "°";
        document.getElementById('max_r_knee').innerText = Math.round(getMax('r_knee')) + "°";

        const timeLabels = recordingData.map(d => (d.t / 30).toFixed(2));
        const opt = { 
            responsive: true, maintainAspectRatio: false, 
            scales: { x: { title: { display: true, text: '時間 (秒)', color: '#888' } }, y: { min: 0, max: 180, ticks: { callback: v => v + '°', color: '#888' } } },
            plugins: { legend: { labels: { color: '#fff' } } }
        };

        if (hipChart) hipChart.destroy();
        hipChart = new Chart(document.getElementById('hip_chart'), { type: 'line', data: { labels: timeLabels, datasets: [{ label: '左髖', data: recordingData.map(d => d.l_hip), borderColor: '#0d47a1', tension: 0.2, pointRadius: 0 }, { label: '右髖', data: recordingData.map(d => d.r_hip), borderColor: '#42a5f5', tension: 0.2, pointRadius: 0 }] }, options: opt });

        if (kneeChart) kneeChart.destroy();
        kneeChart = new Chart(document.getElementById('knee_chart'), { type: 'line', data: { labels: timeLabels, datasets: [{ label: '左膝', data: recordingData.map(d => d.l_knee), borderColor: '#1b5e20', tension: 0.2, pointRadius: 0 }, { label: '右膝', data: recordingData.map(d => d.r_knee), borderColor: '#81c784', tension: 0.2, pointRadius: 0 }] }, options: opt });
        
        const pbVideo = document.getElementById('playback_video');
        pbVideo.currentTime = 0; pbVideo.play();
    };

    document.getElementById('back_to_live').onclick = () => {
        document.getElementById('report_view').style.display = 'none';
        canvasElement.style.display = 'block';
        toggleBtn.disabled = false; startBtn.disabled = false; stopBtn.disabled = true; reportBtn.disabled = false;
    };

    document.getElementById('download_csv_report').onclick = () => {
        let fileName = window.prompt("請輸入報告檔名：", `report_${new Date().getTime()}`);
        if (!fileName) return;
        const rows = recordingData.map(d => `${(d.t/30).toFixed(2)},${Math.round(d.l_hip)},${Math.round(d.r_hip)},${Math.round(d.l_knee)},${Math.round(d.r_knee)}`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["Time(s),L_Hip,R_Hip,L_Knee,R_Knee\n" + rows.join("\n")], { type: 'text/csv;charset=utf-8;' }));
        a.download = `${fileName}.csv`; a.click();
    };

    const pose = new Pose({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    pose.onResults(onResults);
    new Camera(videoElement, { onFrame: async () => await pose.send({image: videoElement}), width: 1280, height: 720 }).start();
</script>

</body>
</html>